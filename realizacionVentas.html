<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US-06 Realización de Ventas</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #fbc2eb, #a6c1ee);
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 20px;  /* Box model */
      margin: 10px;   /* Box model */
    }
    .btn-custom {
      background-color: #e76f51;
      color: white;
      font-weight: 600;
    }
    .btn-custom:hover {
      background-color: #c1573e;
    }
    .sale-list {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-6 col-lg-5">
        <section class="card d-flex flex-column">
          <h3 class="text-center mb-4">Realización de Ventas</h3>

          <!-- Formulario de venta eliminado según petición (producto, cantidad, método de pago y botón confirmación) -->

          <div class="mt-4">
            <h5 class="text-center">Comprobante de Ventas</h5>
            <ul id="saleList" class="list-group sale-list"></ul>
            <div id="cartSummary" class="mt-3"></div>
            <div class="d-flex gap-2 mt-2">
              <button id="processCartBtn" class="btn btn-success flex-fill">Procesar venta (carrito)</button>
              <button id="payBtn" class="btn btn-primary flex-fill">Pagar y volver al inicio</button>
            </div>
              <div class="mt-3">
                <label class="form-label">Método de pago</label>
                <div class="d-flex gap-3 align-items-center mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="metodoPago" id="pagoTarjeta" value="tarjeta" checked>
                    <label class="form-check-label" for="pagoTarjeta">Tarjeta</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="metodoPago" id="pagoEfectivo" value="efectivo">
                    <label class="form-check-label" for="pagoEfectivo">Efectivo</label>
                  </div>
                </div>

                <div id="cardForm">
                  <input id="cardName" type="text" class="form-control mb-2" placeholder="Nombre en la tarjeta">
                  <input id="cardNumber" type="text" class="form-control mb-2" placeholder="Número de tarjeta (sin espacios)">
                  <div class="d-flex gap-2">
                    <input id="cardExp" type="text" class="form-control" placeholder="MM/AA">
                    <input id="cardCVV" type="text" class="form-control" placeholder="CVV">
                  </div>
                  <div id="cardError" class="text-danger small mt-2" style="display:none"></div>
                </div>
              </div>
          </div>

          <div class="mt-4 text-center">
            <a href="generacionPedidos.html" class="text-decoration-none me-3">➡ Ir a pedidos</a>

             <!-- ⬅ ➡ -->
            <a href="anulacionCompras.html" class="text-decoration-none"> Anular producto</a>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const lista = document.getElementById("saleList");
    const cartSummary = document.getElementById('cartSummary');
    const processCartBtn = document.getElementById('processCartBtn');

    function leerCarritoLocal(){
      try{ return JSON.parse(localStorage.getItem('carrito_v1')||'[]'); }catch(e){ return []; }
    }

    function renderCarritoEnVenta(){
      const carrito = leerCarritoLocal();
      if(!carrito || carrito.length === 0){ cartSummary.innerHTML = '<div class="muted">No hay items en el carrito.</div>'; processCartBtn.disabled = true; return; }
      let html = '<ul class="list-group mb-2">';
      let total = 0;
      carrito.forEach(i=>{
        const lineTotal = (Number(i.precio)||0) * (Number(i.cantidad)||1);
        html += `<li class="list-group-item d-flex justify-content-between">${i.nombre} x ${i.cantidad || 1} <span>$${lineTotal}</span></li>`;
        total += lineTotal;
      });
      html += `</ul><div><strong>Total carrito: $${total}</strong></div>`;
      cartSummary.innerHTML = html;
      processCartBtn.disabled = false;
    }

    processCartBtn.addEventListener('click', ()=>{
      const carrito = leerCarritoLocal();
      if(!carrito || carrito.length === 0){ alert('No hay items en el carrito.'); return; }
      let total = 0;
      carrito.forEach(i=>{
        const qty = Number(i.cantidad)||1;
        const lineTotal = (Number(i.precio)||0) * qty;
        total += lineTotal;
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `${qty} x ${i.nombre} - Total: $${lineTotal} <button class="btn btn-sm btn-danger">Eliminar</button>`;
        li.querySelector('button').addEventListener('click', ()=> lista.removeChild(li));
        lista.appendChild(li);
      });
      alert('Venta(s) procesada(s) desde carrito. Total: $' + total);
      try{ localStorage.removeItem('carrito_v1'); }catch(e){}
      renderCarritoEnVenta();
    });

    // Pagar y volver al inicio: guarda el pedido en 'pedidos', limpia carrito y redirige a index.html
    const payBtn = document.getElementById('payBtn');
    function guardarPedidoFinal(ped){
      try{
        const existing = JSON.parse(localStorage.getItem('pedidos')||'[]');
        existing.push(ped);
        localStorage.setItem('pedidos', JSON.stringify(existing));
      }catch(e){ console.error('No se pudo guardar pedido', e); }
    }

    payBtn.addEventListener('click', ()=>{
      const carrito = leerCarritoLocal();
      if(!carrito || carrito.length === 0){ alert('No hay items en el carrito.'); return; }
      if(!confirm('Confirmar pago y volver al inicio?')) return;

      let total = 0;
      const resumen = carrito.map(i=>{
        const qty = Number(i.cantidad)||1;
        const lineTotal = (Number(i.precio)||0) * qty;
        total += lineTotal;
        return { nombre: i.nombre, cantidad: qty, linea: lineTotal, descripcion: i.descripcion || '' };
      });

      // manejar método de pago
      const metodo = document.querySelector('input[name="metodoPago"]:checked').value;
      let pagoInfo = { metodo };
      if(metodo === 'tarjeta'){
        const name = document.getElementById('cardName').value.trim();
        const number = document.getElementById('cardNumber').value.replace(/\s+/g,'').trim();
        const exp = document.getElementById('cardExp').value.trim();
        const cvv = document.getElementById('cardCVV').value.trim();

        // validaciones básicas
        const cardErrorEl = document.getElementById('cardError');
        cardErrorEl.style.display = 'none';
        if(!name || number.length < 12 || !/^[0-9]{12,19}$/.test(number) || !/^[0-9]{3,4}$/.test(cvv) || !/^(0[1-9]|1[0-2])\/[0-9]{2}$/.test(exp)){
          cardErrorEl.textContent = 'Revisa los datos de la tarjeta (número, vencimiento MM/AA y CVV).';
          cardErrorEl.style.display = 'block';
          return;
        }

        // maskear número (ultimos 4 dígitos)
        const masked = '**** **** **** ' + number.slice(-4);
        pagoInfo = { metodo: 'tarjeta', nombreTitular: name, tarjetaUlt4: number.slice(-4), tarjetaMask: masked };
      }

      const pedido = { id: 'pedido_' + Date.now(), items: resumen, total, fecha: new Date().toISOString(), pago: pagoInfo };
      guardarPedidoFinal(pedido);

      alert('Pago realizado. Total: $' + total.toLocaleString('es-CL') + '. Serás llevado al inicio.');
      try{ localStorage.removeItem('carrito_v1'); }catch(e){}
      renderCarritoEnVenta();
      // redirigir al inicio
      window.location.href = 'index.html';
    });

    // Mostrar/ocultar formulario de tarjeta según método
    function toggleCardForm(){
      const metodo = document.querySelector('input[name="metodoPago"]:checked').value;
      const cardForm = document.getElementById('cardForm');
      if(metodo === 'tarjeta') cardForm.style.display = 'block'; else cardForm.style.display = 'none';
    }
    document.querySelectorAll('input[name="metodoPago"]').forEach(r => r.addEventListener('change', toggleCardForm));
    // Inicializar
    toggleCardForm();

    window.addEventListener('load', ()=>{ renderCarritoEnVenta(); });
  </script>
</body>
</html>
